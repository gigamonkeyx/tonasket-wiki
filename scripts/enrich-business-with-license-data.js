/**
 * Business License Enrichment Script
 * 
 * This script enriches the business directory with license data from the
 * Washington State Department of Revenue's business license dataset.
 * 
 * Usage:
 *   node scripts/enrich-business-with-license-data.js [zipCode] [limit]
 * 
 * Example:
 *   node scripts/enrich-business-with-license-data.js 98855 50
 */

// Load environment variables
require('dotenv').config();

// Import required modules
const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

// Parse command line arguments
const zipCode = process.argv[2] || '98855'; // Default to Tonasket
const limit = parseInt(process.argv[3] || '50', 10); // Default to 50 businesses

console.log(`
Business License Enrichment Script
==================================
Enriching businesses in ZIP code ${zipCode} (limit: ${limit})
`);

// Check if the required environment variables are set
if (!process.env.SOCRATA_APP_TOKEN) {
  console.warn('Warning: SOCRATA_APP_TOKEN is not set. API rate limits may apply.');
}

// Build and run the enrichment process
console.log('Building the enrichment service...');
try {
  execSync('npx tsc --project tsconfig.node.json', { stdio: 'inherit' });
  console.log('Build successful.');
} catch (error) {
  console.error('Build failed:', error);
  process.exit(1);
}

// Run the enrichment process
console.log(`\nRunning business enrichment with license data for ZIP code ${zipCode}...`);
try {
  // Import the enrichment service
  const { enrichBusinessData } = require('../dist/services/businessEnrichment');
  
  // Run the enrichment process
  enrichBusinessData(zipCode, limit)
    .then(enrichedBusinesses => {
      console.log(`\nEnrichment complete. Enriched ${enrichedBusinesses.length} businesses.`);
      
      // Save the enriched data to a JSON file
      const outputDir = path.join(__dirname, '..', 'src', 'data');
      const outputPath = path.join(outputDir, 'enriched-businesses.json');
      
      fs.writeFileSync(
        outputPath,
        JSON.stringify(enrichedBusinesses, null, 2),
        'utf8'
      );
      
      console.log(`Saved enriched data to ${outputPath}`);
      
      // Generate TypeScript file
      const tsOutputPath = path.join(outputDir, 'enriched-businesses.ts');
      
      fs.writeFileSync(
        tsOutputPath,
        `/**
 * Enriched Business Data
 * 
 * This file was automatically generated by the business enrichment process.
 * Last updated: ${new Date().toISOString()}
 */

import { Business } from './businesses';

export const enrichedBusinesses: Business[] = ${JSON.stringify(enrichedBusinesses, null, 2)};

export const enrichmentTimestamp = '${new Date().toISOString()}';
export const enrichmentSource = 'Washington State Department of Revenue Business License Dataset';

export default enrichedBusinesses;
`,
        'utf8'
      );
      
      console.log(`Generated TypeScript file at ${tsOutputPath}`);
      console.log('\nEnrichment process completed successfully.');
    })
    .catch(error => {
      console.error('Enrichment process failed:', error);
      process.exit(1);
    });
} catch (error) {
  console.error('Failed to run enrichment process:', error);
  process.exit(1);
}
